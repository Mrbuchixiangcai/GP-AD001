C51 COMPILER V9.00   VOICE_IC                                                              08/25/2018 10:15:36 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE VOICE_IC
OBJECT MODULE PLACED IN .\Objects\voice_ic.obj
COMPILER INVOKED BY: D:\ProgramFiles\Keil_v5\C51\BIN\C51.EXE source\voice_ic.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\i
                    -nclude) DEBUG OBJECTEXTEND PRINT(.\Listings\voice_ic.lst) OBJECT(.\Objects\voice_ic.obj)

line level    source

   1          //头文件header file//
   2          #include "app_main.h"
   3          
   4          //宏定义macro definition//
   5          
   6          //类型定义byte definition//
   7          SPA_NAME      spa_name; //枚举变量类型
   8          SPA_NAME      spa_name_bk;
   9          VOICE_STEP    Voice_Step; //语音步骤枚举变量类型
  10          
  11          
  12          //变量定义variable definition//
  13          uint8_t idata voice_send_step; //语音发送步骤
  14          uint8_t idata voice_send_data; //语音发送数据
  15          uint8_t idata voice_50us_cnt; //50us计时
  16          uint8_t idata voice_50us_cnt_set; //50us计时设计
  17          uint8_t idata spa_cmd; //spa命令
  18          uint8_t idata spa_volume; //音量
  19          uint8_t idata cur_spa_name;
  20          uint8_t idata cntSPAOn;
  21          code uint8_t voice_vol_tab[]=
  22          {
  23                  0x00,0x01,0x02,0x03,0x05,0x07,
  24                  0x09,0x0A,0x0C,0x0E,0x0F,
  25          };
  26          
  27          //标志未定义flags definetion//
  28          bit       gbVoice_Work;
  29          bit   flag_voice_send; //语音发送标志
  30          bit   enable_SPApause;//为1为暂停
  31          
  32          /*******************************************************************
  33          函数原型：
  34          输入参数：
  35          输出参数：
  36          函数功能：设置语音音量 
  37          *******************************************************************/
  38          void set_voice_vol(uint8_t vol) //设置语音音量 
  39          {
  40   1              voice_send(SPA_VOL15-voice_vol_tab[vol]);
  41   1      }
  42          
  43          /*******************************************************************
  44          函数原型：
  45          输入参数：
  46          输出参数：
  47          函数功能：语音发送
  48          *******************************************************************/
  49          void voice_send(uint8_t key) //语音发送
  50          {
  51   1              if(!flag_voice_send)
  52   1              {
  53   2                      flag_voice_send = 1;
  54   2                      voice_send_data = key-1;
C51 COMPILER V9.00   VOICE_IC                                                              08/25/2018 10:15:36 PAGE 2   

  55   2                      voice_send_step = 0;
  56   2                      voice_50us_cnt =  0;
  57   2                      VOIC_DATA(0); //端口电平置位//复位宏定义
  58   2                      voice_50us_cnt_set =200;//change1
  59   2              }
  60   1      }
  61          
  62          /*******************************************************************
  63          函数原型：
  64          输入参数：
  65          输出参数：
  66          函数功能：语音发送时间及顺序
  67          *******************************************************************/
  68          void voice_in_timer(void)
  69          {
  70   1              if(flag_voice_send)
  71   1              {
  72   2                      if(++voice_50us_cnt >= voice_50us_cnt_set)
  73   2                      {
  74   3                              voice_50us_cnt = 0;
  75   3                              switch(voice_send_step) //协议
  76   3                              {
  77   4                                      case 0:         
  78   4                                      VOIC_DATA(1); 
  79   4                                              voice_50us_cnt_set = 160;
  80   4                                              break;                                  
  81   4                                      case 1:
  82   4                                              VOIC_DATA(0); 
  83   4                                              voice_50us_cnt_set = 20;                        
  84   4                                              break;
  85   4                                      case 2:
  86   4                                      case 4:
  87   4                                      case 6:
  88   4                                      case 8:
  89   4                                      case 10:
  90   4                                      case 12:
  91   4                                      case 14:
  92   4                                      case 16:
  93   4                                              VOIC_DATA(1);
  94   4                                              if(voice_send_data & 0x80)
  95   4                                                      voice_50us_cnt_set = 30;
  96   4                                              else
  97   4                                                      voice_50us_cnt_set = 10;
  98   4                                              break;
  99   4                                      case 2+1:
 100   4                                      case 4+1:
 101   4                                      case 6+1:
 102   4                                      case 8+1:
 103   4                                      case 10+1:
 104   4                                      case 12+1:
 105   4                                      case 14+1:
 106   4                                      case 16+1:
 107   4                                              VOIC_DATA(0); ; 
 108   4                                              if(voice_send_data & 0x80)
 109   4                                                      voice_50us_cnt_set = 10;
 110   4                                              else
 111   4                                                      voice_50us_cnt_set =30;
 112   4                                              voice_send_data=voice_send_data<<1;
 113   4                                              break;
 114   4                                      case 17+1:
 115   4                                                      voice_50us_cnt_set = 200;
 116   4                                              break;
C51 COMPILER V9.00   VOICE_IC                                                              08/25/2018 10:15:36 PAGE 3   

 117   4                                      default:
 118   4                                              VOIC_DATA(0);
 119   4                                              flag_voice_send = 0;
 120   4                                              break;
 121   4                              }
 122   3                              voice_send_step++;
 123   3                      }       
 124   2              }
 125   1      }
 126          
 127          /*******************************************************************
 128          函数原型：
 129          输入参数：
 130          输出参数：
 131          函数功能：被主函数调用
 132          *******************************************************************/
 133          void DealWith_Voice(void) //被主函数调用
 134          {
 135   1              if(PlayMode == PLAY_MUSIC)
 136   1              {
 137   2                      if(gbVoice_Work==0)
 138   2                      { //类似于初始化，用于刷新数据
 139   3                              cntSPAOn=0;
 140   3                              cur_spa_name=~spa_name;
 141   3                              spa_volume  =~sys_volume; 
 142   3                              Voice_Step=VOICE_STEP_START;
 143   3                      }
 144   2                      gbVoice_Work=1; 
 145   2                      switch(Voice_Step)
 146   2                      {
 147   3                              case VOICE_STEP_START:
 148   3                                      EN_MUTE();
 149   3                                      if(++cntSPAOn>25)
 150   3                                      {
 151   4                                        CLR_AUCH();
 152   4                                              SET_BT_POWER(); //置位PA11，对应蓝牙芯片的vbat脚
 153   4                                              cntSPAOn=0;
 154   4                                              Voice_Step++;
 155   4                                      }
 156   3                                      break;
 157   3                              case VOICE_STEP_INITI1:
 158   3              UART1_init(); 
 159   3                                      SET_VOICE_POWER();
 160   3                                      if(++cntSPAOn>50)
 161   3                                      {
 162   4                                              cntSPAOn=0;
 163   4                                              Voice_Step++;
 164   4                                      }
 165   3                                      break;
 166   3                              case VOICE_STEP_INITI2:
 167   3                                      if(++cntSPAOn>200)
 168   3                                      {
 169   4                                              Voice_Step++;
 170   4                                              cntSPAOn=0;
 171   4                                      }
 172   3                                      break;
 173   3                              case VOICE_STEP_INITI3:
 174   3                                      Voice_Step++;
 175   3                                      break;
 176   3                              default: 
 177   3                                      if(spa_cmd)
 178   3                                      { 
C51 COMPILER V9.00   VOICE_IC                                                              08/25/2018 10:15:36 PAGE 4   

 179   4                                              if(!flag_voice_send) 
 180   4                                              {
 181   5                                                      if(spa_cmd==SPA_PAUSE)
 182   5                                                              Uart0Transmit_SendString(&SPASongs_Num_Table[0][0]);
 183   5                                                      if(spa_cmd==SPA_PALY)
 184   5                                                              Uart0Transmit_SendString(&SPASongs_Num_Table[spa_name][0]);
 185   5                                                      voice_send(spa_cmd);
 186   5                                                      spa_cmd=0;
 187   5                                              }
 188   4                                      } 
 189   3                                      else if(spa_name!=cur_spa_name) 
 190   3                                      {
 191   4                                              if(!flag_voice_send) 
 192   4                                              {
 193   5                                                      cur_spa_name=spa_name;
 194   5                                                      if((spa_name==SPA_OFF)||(spa_name==SPA_PAUSE))
 195   5                                                      {
 196   6                                                              enable_SPApause=1;
 197   6                                                              cur_spa_name=SPA_PAUSE;
 198   6                                                              Uart0Transmit_SendString(&SPASongs_Num_Table[0][0]);
 199   6                                                      }
 200   5                                                else if((spa_name<=SPA_ZEN))
 201   5                                                      {
 202   6                                                              Uart0Transmit_SendString(&SPASongs_Num_Table[spa_name][0]);
 203   6                                                      }
 204   5                                                      voice_send(cur_spa_name);       
 205   5                                                      cur_spa_name=spa_name;
 206   5                                              }
 207   4                                      }
 208   3                                      else if(sys_volume!=spa_volume)
 209   3                                      {
 210   4                                              if(!flag_voice_send)
 211   4                                              {
 212   5                                                      spa_volume=sys_volume;
 213   5                                      set_voice_vol(sys_volume);
 214   5                                              }
 215   4                                      }
 216   3                                      else if((enableMute!=enableMute_bk)&&(!Uart0_SendString_3Step))
 217   3                                      {
 218   4                                              enableMute_bk=enableMute;
 219   4                                              if(enableMute)
 220   4                                              {
 221   5                                                      Uart0Transmit_SendString(&SPASongs_Num_Table[0][0]);
 222   5                                              }
 223   4                                              else
 224   4                                              {
 225   5                                                      Uart0Transmit_SendString(&SPASongs_Num_Table[spa_name][0]);
 226   5                                              }
 227   4                                      }
 228   3                                      else
 229   3                                      {
 230   4                                       if((enable_SPApause) || (enableMute) || (sys_volume==0))
 231   4                                              EN_MUTE();
 232   4                                       else 
 233   4                                              DE_MUTE();
 234   4                                      }
 235   3                                      break;
 236   3                      }
 237   2              }       
 238   1              else
 239   1              {
 240   2                      if(gbVoice_Work!=0)
C51 COMPILER V9.00   VOICE_IC                                                              08/25/2018 10:15:36 PAGE 5   

 241   2                      {
 242   3                              Voice_Step=VOICE_STEP_START; //为下一次发送做准备，所以赋值为start
 243   3                      }
 244   2                      gbVoice_Work=0;
 245   2                      switch(Voice_Step)
 246   2                      {
 247   3                              case VOICE_STEP_START:
 248   3                                      if(!flag_bt_conn)
 249   3                                              EN_MUTE();
 250   3                                      Voice_Step++;
 251   3                                      break;
 252   3                              case VOICE_STEP_INITI1:
 253   3                                      if(++cntSPAOn>20)
 254   3                                      {
 255   4                                              cntSPAOn=0;  
 256   4                                        SET_VOICE_POWER();
 257   4                                              Voice_Step++;
 258   4                                      }
 259   3                                      break;
 260   3                              case VOICE_STEP_INITI2:
 261   3                                      if(!Uart0_SendString_3Step)
 262   3                                      {
 263   4                                              Uart0Transmit_SendString(&SPASongs_Num_Table[0][0]);
 264   4                                              Voice_Step++;
 265   4                                      }
 266   3                                      break;
 267   3                              case VOICE_STEP_INITI3:
 268   3                                      if(!flag_bt_conn)
 269   3                                              Voice_Step++;
 270   3                                      break;
 271   3                              default: 
 272   3                                      break;
 273   3                      }
 274   2              }
 275   1      }
 276          
 277          
 278          
 279          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    656    ----
   CONSTANT SIZE    =     11    ----
   XDATA SIZE       =      3    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =      8    ----
   BIT SIZE         =      3    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
