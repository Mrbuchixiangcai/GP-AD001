C51 COMPILER V9.00   KEY                                                                   08/04/2018 12:05:31 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE KEY
OBJECT MODULE PLACED IN .\Objects\key.obj
COMPILER INVOKED BY: D:\ProgramFiles\Keil_v5\C51\BIN\C51.EXE source\key.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\includ
                    -e) DEBUG OBJECTEXTEND PRINT(.\Listings\key.lst) OBJECT(.\Objects\key.obj)

line level    source

   1          //Í·ÎÄ¼þheader file//
   2          #include "app_main.h"
   3          
   4          #define   ADCKEY_NUM  8
   5          
   6          uint8_t   gbKeyPress; //°´¼ü°´ÏÂ
   7          uint8_t   gbKeyNone;  //Ã»ÓÐ°´¼ü°´ÏÂ
   8          uint8_t   KeyValue;   //°´¼üÖµ
   9          uint16_t  AdcValue;   //×î³õ²É¼¯µÄADÖµ
  10          uint8_t   KeyEvent;   //°´¼üÊÂ¼þ
  11          uint8_t   cntKeyLoop; //¼ÆÊý°´¼üÑ­»·£¬¶Ì°´£¬³¤°´£¬³¬³¤°´µÄ°´ÏÂÊ±¼ä
  12          uint8_t   cntKeylong;
  13          uint8_t   KeyCurValueBK;//µ±Ç°°´¼üÖµ±¸·Ý
  14          uint8_t   KeyCurValue; //°´¼üµçÑ¹µ±Ç°Öµ  currentµ±Ç°µÄ
  15          uint8_t   KeyLastValue;//°´¼üµçÑ¹ÉÏÒ»´ÎµÄÖµ
  16          code uint16_t ADKEY_TAB1[ADCKEY_NUM]= //°´¼üÕý³£µçÑ¹ÖµÓëÔÊÐíÎó²îÖµ
  17          {
  18                  0x0000     ,//power power¼üÕý³£µçÑ¹Öµ
  19                  0x0510-0x50,//sound sound¼üÕý³£µçÑ¹Öµ
  20                  0x0651-0x50,//v+//ÒÑ¾­Ê§Ð§
  21                  0x08B7-0x50,//v-
  22                  0x0AE0-0x50,//timer
  23                  0x0C35-0x50,//light
  24                  0x0DA6-0x50,//BT
  25                  0x0E00,
  26          };
  27          code uint16_t ADKEY_TAB2[ADCKEY_NUM]= //°´¼üÕý³£µçÑ¹ÖµÓëÔÊÐíÎó²îÖµ
  28          {
  29                  0x0000+0x50,//power
  30                  0x0510+0x50,//sound
  31                  0x0651+0x50,//v+//ÒÑ¾­Ê§Ð§
  32                  0x08B7+0x50,//v-
  33                  0x0AE0+0x50,//timer
  34                  0x0C35+0x50,//light
  35                  0x0DA6+0x50,//BT
  36                  0x0E00,
  37          };
  38          
  39          uint8_t GetKeyValue(void) 
  40          { 
  41   1              uint8_t  i;
  42   1              uint8_t  KeyNum=0;
  43   1              AdcValue=ADC_read();
  44   1              if(AdcValue<0x0fa0) //²É¼¯µ½µÄÈÎÒâ°´¼üµçÑ¹ÖµÒªÐ¡ÓÚ4000mv(0x0fa0)
  45   1              {
  46   2                      for(i=0;i<ADCKEY_NUM;i++)
  47   2                      {
  48   3                              if((AdcValue>=ADKEY_TAB1[i])&&(AdcValue<=ADKEY_TAB2[i])) //ÅÐ¶Ï²É¼¯µ½µÄ°´¼üµçÑ¹ÖµÎªÄÄÒ»¸ö°´¼ü
  49   3                              {
  50   4                                      KeyNum=i+1; //È·¶¨ÎªÄÇ¸ö°´¼ü£¬ÒòÎªi³õÊ¼Îª0£¬ËùÒÔ¼Ó1£¬
  51   4                                      break;
  52   4                              }
  53   3                      }
  54   2              }
C51 COMPILER V9.00   KEY                                                                   08/04/2018 12:05:31 PAGE 2   

  55   1              ADC_start(5);
  56   1              if((KeyNum==T_VOLDEC)&&(!KeyVolAdd())) //Í¬Ê±°´ÏÂ¡°ÒôÁ¿-¡±ºÍ¡°ÒôÁ¿+¡±10sÖØÖÃÕû¸öÉè±¸
  57   1                      KeyNum=T_DEFAULT;
  58   1              else if((KeyNum==T_POWER)&&(!KeyVolAdd())) //Í¬Ê±°´ÏÂ¡°ÒôÁ¿-¡±ºÍ¡°ÒôÁ¿+¡±10sÖØÖÃÕû¸öÉè±¸
  59   1                      KeyNum=T_CLEAR;
  60   1              else if((KeyNum==T_MUSIC)&&(!KeyVolAdd())) //Í¬Ê±°´ÏÂ¡°ÒôÀÖ¼ü¡±ºÍ¡°ÒôÁ¿+¡±10s½øÈë²âÊÔÄ£Ê½
  61   1                      KeyNum=T_TESTMODE;
  62   1              else if(!KeyVolAdd())
  63   1                      KeyNum=T_VOLINC;
  64   1              return KeyNum; //·µ»Ø°´¼ü
  65   1      }
  66          
  67          void KeyEventPorc(uint8_t KeyTmp) //±»µ÷ÓÃÊ±½ÓÊÕµÄÊÇGetKeyValue()µÄ·µ»ØÖµ  Ò»°ã¹Ì¶¨£¬²»¸ü¸Ä
  68          {
  69   1              gbKeyPress=0;
  70   1              if(KeyCurValue!=KeyTmp) //Õâ¸öifÓï¾äÊÇÈ¥¶¶£¬»á±»Ö´ÐÐÁ½´Î£¬µÚÈý´Î½øÀ´Ê±Ö±½ÓÌø¹ý
  71   1              {//KeyTmpÎªÁÙÊ±Öµ£¬
  72   2                      if(KeyCurValueBK!=KeyTmp)
  73   2                              KeyCurValueBK=KeyTmp;
  74   2                      else //µÚ¶þ´Î½øÀ´Ê±Ö´ÐÐÕâÒ»Ìõ
  75   2                              KeyCurValue=KeyTmp; //
  76   2                      return;
  77   2              }
  78   1              if(KeyCurValue==KeyLastValue)
  79   1              {
  80   2                      if((KeyLastValue==0) || (cntKeyLoop==0))
  81   2                              return;
  82   2                      if(--cntKeyLoop==0) //Õâ¸öÔÚµÚ¶þ´Î½øKeyEventPorc()º¯Êý£¨µÚÒ»´Î½ø¡°if(KeyCurValue==KeyLastValue)¡±Ö®Ç°£©Ê
             -±±»ÏÂÃæ¸³ÖµÎª5
  83   2                      { //cntKeyLoopÎª5¾ÍÊÇ50msÊ±¼ä
  84   3                              KeyValue=KeyLastValue; //·À¶¶Ö®ºó°ÑÈ·¶¨µÄ°´¼ü¸³Öµ¸øKeyValue
  85   3                              if(gbKeyNone==0)
  86   3                                      gbKeyPress=1;
  87   3                              switch(KeyEvent)
  88   3                              {
  89   4                                      case 0:
  90   4                                              KeyEvent=1;
  91   4                                              KeyValue |= K_D;
  92   4                                              cntKeyLoop=cKEY_HOLD;
  93   4                                              break;
  94   4                                      case 1:
  95   4                                              KeyEvent=2;
  96   4                                              KeyValue |= K_H;
  97   4                                              cntKeyLoop=cKEY_RATE_VOL;
  98   4                                              break;
  99   4                                              case 2:
 100   4                                      case 3:
 101   4                                              KeyEvent=3;
 102   4                                              KeyValue |= K_R;
 103   4                                              cntKeyLoop=cKEY_RATE_VOL;
 104   4                                              if(cntKeylong<250)
 105   4                                                      cntKeylong++;
 106   4                                              break;
 107   4                              }
 108   3                      }
 109   2              }
 110   1              else
 111   1              {
 112   2                      if(KeyLastValue)
 113   2                      {
 114   3                              KeyValue=KeyLastValue;
 115   3                              if(gbKeyNone==0)
C51 COMPILER V9.00   KEY                                                                   08/04/2018 12:05:31 PAGE 3   

 116   3                                      gbKeyPress=1;
 117   3                              switch(KeyEvent)
 118   3                              {
 119   4                                      case 1:KeyValue |= K_U; break;
 120   4                                      case 2:KeyValue |= K_LU;break;
 121   4                                      case 3:KeyValue |= K_LU;break;
 122   4                              }
 123   3                              KeyEvent=0;
 124   3                      }
 125   2                      else
 126   2                      {
 127   3                              gbKeyNone=0;
 128   3                              cntKeylong=0;
 129   3                      }
 130   2                      cntKeyLoop=cKEY_CLICK;
 131   2                      KeyLastValue=KeyCurValue;
 132   2              }
 133   1      }
 134          
 135          //
 136          void KeyScan(void) //±»Ö÷º¯Êýµ÷ÓÃ
 137          {
 138   1              KeyEventPorc(GetKeyValue());
 139   1      }
 140          
 141          //
 142          void KeyComMsg(void) 
 143          {
 144   1              if(gbKeyPress)
 145   1              { 
 146   2                      if(alarm.Runing)
 147   2                      {
 148   3                              alarm.Runing=0;
 149   3                              gbKeyNone=1;//ÐÞ¸´ÄÖÖÓÄ£Ê½Ê±Ä³Ð©°´¼ü¹Ø±ÕÄÖÖÓ²¢¹Ø»úÊ±¹Ø²»ÁËµÄÎÊÌâ£¬Îª1ÈÃµ¯ÆðµÄ°´¼üÎÞÐ§
 150   3                              //color_mode=COLOR_OFF;
 151   3                              Uart0_SendString_3Step=5;
 152   3                              GP389_OFF();
 153   3                              //ApplicationGP389_ONOFF((PlayMode==PLAY_OFF)?1:0);     
 154   3                              TimerMode=cntTimer=alarm.cntTimer=TIMER_OFF;    
 155   3                              return;
 156   3                      }
 157   2                      //Flag_data_bk=1;//Êý¾Ý¸Ä±äÊ±±¸·Ý
 158   2                      switch(KeyValue)
 159   2                      {
 160   3                              case KU(T_POWER):
 161   3                              {}
 162   3                              case KLU(T_POWER): //value65 Ã¿¸ö°´¼ü7¸öÄ£Ê½ 
 163   3                              {
 164   4                                      if(cntKeylong>=25)
 165   4                                              break;
 166   4                                      Uart0_SendString_3Step=5;
 167   4                                      if(PlayMode!=PLAY_OFF)
 168   4                                      {
 169   5                                              GP389_OFF(); //
 170   5                                      }
 171   4                                      else
 172   4                                              GP389_ON(); //
 173   4                                      //ApplicationGP389_ONOFF((PlayMode==PLAY_OFF)?1:0);
 174   4                                      break;
 175   4                              }
 176   3                              case KR(T_POWER): //value97 Ã¿¸ö°´¼ü7¸öÄ£Ê½£¬
 177   3                              {
C51 COMPILER V9.00   KEY                                                                   08/04/2018 12:05:31 PAGE 4   

 178   4                                      if(PlayMode!=PLAY_OFF)
 179   4                                      {
 180   5                                              if(cntKeylong==25)//³¤°´5s½øÈëwifiÅä¶Ô
 181   5                                              {
 182   6                                                      Uart0_SendString_3Step=5;
 183   6                                                      Uart0Transmit_SendString("$$$ATWQ\r\n"); 
 184   6                                              }
 185   5                                              break;
 186   5                                      }
 187   4                              }
 188   3                              if(PlayMode!=PLAY_OFF)//ÔÚ¿ª»ú×´Ì¬ÏÂ²Å¿ÉÒÔ²Ù×÷ÆäËû°´¼ü
 189   3                              {
 190   4                                      case KU(T_MUSIC): //value66
 191   4                                      {
 192   5                                              if((PlayMode==PLAY_ON) || (PlayMode==PLAY_BT)) //¿ª»ú½øÈë
 193   5                                              {
 194   6                                                      enableMute=0;
 195   6                                                      enable_SPApause=0;
 196   6                                                      PlayMode=PLAY_MUSIC;
 197   6                                                      if(spa_name==SPA_NONE) //spa_nameÎªÃ¶¾Ù±äÁ¿ÀàÐÍ£¬SPA_WHITENOISEÎªÃ¶¾Ù±äÁ¿ÔªËØ
 198   6                                                      {
 199   7                                                              spa_name=SPA_BRAHM_LULLABY;
 200   7                                                      }
 201   6                                              }
 202   5                                              else if(PlayMode==PLAY_MUSIC) //µÚ¶þ´Î½øÈë
 203   5                                              {
 204   6                                                      enableMute=0;
 205   6                                                      if(enable_SPApause)
 206   6                                                      {
 207   7                                                              enable_SPApause=0;
 208   7                                                              spa_cmd=SPA_PALY;
 209   7                                                              break;
 210   7                                                      }
 211   6                                                      enable_SPApause=0;
 212   6                                                      if(++spa_name>SPA_WHITENOISE)
 213   6                                                      {
 214   7                                                              spa_name=SPA_BRAHM_LULLABY;
 215   7              //                                              if(color_mode==COLOR_OFF)
 216   7              //                                                      TimerMode=cntTimer=alarm.cntTimer=TIMER_OFF;    
 217   7              //                                          PlayMode=PLAY_ON;
 218   7              //                                              spa_name=SPA_NONE;
 219   7              //                                              enable_SPApause=1;
 220   7                                                      }
 221   6                                              }
 222   5                                              break;
 223   5                                      }
 224   4                                      case KH(T_MUSIC): //value98
 225   4                                      {
 226   5                                              if(PlayMode == PLAY_MUSIC)
 227   5                                              {
 228   6                                                      enable_SPApause=~enable_SPApause;
 229   6                                                      if(!enable_SPApause)
 230   6                                                      {       
 231   7                                                              enableMute=0;
 232   7                                                              spa_cmd=SPA_PALY;       
 233   7                                                      }
 234   6                                                      else
 235   6                                                      {       
 236   7                                                              spa_cmd=SPA_PAUSE;
 237   7                                                      }
 238   6                                              }
 239   5                                              break;
C51 COMPILER V9.00   KEY                                                                   08/04/2018 12:05:31 PAGE 5   

 240   5                                      }
 241   4                                      case KU(T_VOLINC): //value67 Ã»ÓÐbreakËùÒÔ¼ÌÐøÖ´ÐÐÏÂÒ»ÌõÓï¾ä
 242   4                                      case KR(T_VOLINC): //value131
 243   4                                      {
 244   5                                              if(PlayMode>PLAY_ON) 
 245   5                                              {
 246   6                                                      if(sys_volume<10)
 247   6                                                              sys_volume++;
 248   6                                                      enableMute=0;//
 249   6                                              }
 250   5                                              break;
 251   5                                      }
 252   4                                      case KU(T_VOLDEC): //value68
 253   4                                      case KR(T_VOLDEC): //value132
 254   4                                      {
 255   5                                              if(PlayMode>PLAY_ON) 
 256   5                                              {
 257   6                                                      if(sys_volume >1) //
 258   6                                                              sys_volume--;
 259   6                                                      enableMute=0;//
 260   6                                              }
 261   5                                        break;
 262   5                                      } 
 263   4                                      case KU(T_TIMER): //value37 µ¯ÆðÖ´ÐÐ
 264   4                                      {
 265   5                                              if((PlayMode>PLAY_ON)||(color_mode!=COLOR_OFF)) 
 266   5                                              {
 267   6                                                      if(TimerMode==TIMER_OFF) 
 268   6                                                              TimerMode=cntTimer=TIMER_15MIN;
 269   6                                                      else if(TimerMode==TIMER_15MIN)
 270   6                                                              TimerMode=cntTimer=TIMER_30MIN;
 271   6                                                      else if(TimerMode==TIMER_30MIN)
 272   6                                                              TimerMode=cntTimer=TIMER_60MIN;
 273   6                                                      else 
 274   6                                                              TimerMode=cntTimer=TIMER_OFF;
 275   6                                              }
 276   5                                              break;
 277   5                                      }
 278   4                                      case KU(T_LIGHT): //value70
 279   4                                      {
 280   5                                              if(PlayMode!=PLAY_OFF)
 281   5                                              {
 282   6                                                      if(color_mode==COLOR_USER) 
 283   6                                                              color_mode=COLOR_WHITE; //ÊµÏÖÑ­»·
 284   6                                                      else if(Light_Brightness==0)
 285   6                                                              Light_Brightness=1;
 286   6                                                      else if(++color_mode>COLOR_CHANGE)
 287   6                                                              color_mode=COLOR_WHITE;
 288   6                                                      if(color_mode==COLOR_CHANGE)
 289   6                                                      {
 290   7                                                              play_rgb_index=0;
 291   7                                                              curR_val=0;
 292   7                                                              curG_val=0;
 293   7                                                              curB_val=0;
 294   7                                                      }
 295   6                                              }
 296   5                                              break;
 297   5                                      }
 298   4                                      case KH(T_LIGHT):
 299   4                                      {
 300   5                                              if(color_mode!=COLOR_OFF)
 301   5                                                      if(++Light_Brightness>3) 
C51 COMPILER V9.00   KEY                                                                   08/04/2018 12:05:31 PAGE 6   

 302   5                                                              Light_Brightness=0;
 303   5                                              break;
 304   5                                      }
 305   4                                      case KU(T_BT): 
 306   4                                      {
 307   5                                              if(PlayMode!=PLAY_OFF)
 308   5                                              {
 309   6                                                      if(PlayMode!=PLAY_BT)
 310   6                                                              PlayMode=PLAY_BT;
 311   6                                               //else 
 312   6                                                      //bt_cmd=BT_PAUSE;
 313   6                                              }
 314   5                                              break;
 315   5                                      }
 316   4                                      case KH(T_BT):
 317   4                                      {
 318   5                                              if(PlayMode==PLAY_BT)
 319   5                                                      bt_cmd=BT_PARIR; 
 320   5                                              break;
 321   5                                      }
 322   4                                      case KR(T_DEFAULT): //×éºÏ¼ü£¬³¤°´10s¡°ÒôÁ¿¼ÓºÍÒôÁ¿¼õ¡±Á½¸ö¼ü»Ö¸´³ö³§ÉèÖÃ
 323   4                                      {
 324   5                                              if(cntKeylong==50)
 325   5                                              {                                        
 326   6                                                      cntFlash=0;
 327   6                                                      Led_Flash=0;
 328   6                                                      setFactory=1;//ÖÃÒ»ÈÃÈý¸ötimerµÆ³£ÁÁÈýÃë
 329   6                                                      PlayMode=PLAY_ON;
 330   6                                                      
 331   6                                                      Uart0_SendString_3Step=5;
 332   6                                                      Uart0Transmit_SendString("$$$Factory setting\r\n");
 333   6                                                      bt_send_cmd(BT_CLEAR_LIST);//Çå³ýÀ¶ÑÀÁÐ±íÁÐ±í
 334   6                                              }
 335   5                                              break;
 336   5                                      }
 337   4                                      case KR(T_CLEAR):  //×éºÏ¼ü£¬³¤°´10s¡°powerºÍÒôÁ¿¼Ó¡±Á½¸ö¼üÇå³ýwifiÁÐ±í
 338   4                                      {
 339   5                                              if(cntKeylong==50)
 340   5                                              {                                        
 341   6                                                      setReset=1;     //ÖÃÒ»ÈÃÈý¸ötimerµÆÉÁË¸ÈýÃë
 342   6                                                      cntFlash=0;
 343   6                                                      Led_Flash=0;
 344   6                                                      Uart0_SendString_3Step=5;
 345   6                                                      Uart0Transmit_SendString("$$$Wifi reset\r\n");
 346   6                                              }
 347   5                                              break;
 348   5                                      }
 349   4                                      case KR(T_TESTMODE):  //×éºÏ¼ü£¬³¤°´10s¡°SOUND¡±ºÍ¡°ÒôÁ¿¼Ó¡±Á½¸ö¼ü½øÈë²âÊÔÄ£Ê½
 350   4                                      {
 351   5                                              if(cntKeylong==25)
 352   5                                              {//³¤°´10½øÈë²âÊÔÄ£Ê½£¬È»ºóÍ¨¹ýwifiÄ£¿é·¢ËÍÃüÁî
 353   6                                                      Flag_TestMode=1;
 354   6                                                      cntFlash=0;
 355   6                                                      Led_Flash=0;
 356   6                                                      Uart0_SendString_3Step=3;
 357   6                                                      Uart0Transmit_SendString(Key_MCU_VER);
 358   6                                              }
 359   5                                              break;
 360   5                                      }
 361   4                                      default:
 362   4                                              break;
 363   4                              }
C51 COMPILER V9.00   KEY                                                                   08/04/2018 12:05:31 PAGE 7   

 364   3                      }
 365   2              }
 366   1      }
 367          
 368          
 369          
 370          
 371          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1050    ----
   CONSTANT SIZE    =    104    ----
   XDATA SIZE       =     11       1
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
